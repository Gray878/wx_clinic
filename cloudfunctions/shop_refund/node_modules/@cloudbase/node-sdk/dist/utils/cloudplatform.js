"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.hasPreflight = hasPreflight;
exports.preflightRuntimeCloudPlatform = preflightRuntimeCloudPlatform;
exports.getCloudPlatform = getCloudPlatform;
exports.checkIsInScf = checkIsInScf;
exports.checkIsInCBR = checkIsInCBR;
exports.checkIsInSumeru = checkIsInSumeru;
exports.checkIsInTencentCloud = checkIsInTencentCloud;
exports.checkIsInternal = checkIsInternal;
exports.checkIsInternalAsync = checkIsInternalAsync;
exports.getCurrRunEnvTag = getCurrRunEnvTag;
const metadata_1 = require("./metadata");
const utils_1 = require("./utils");
var CloudPlatform;
(function (CloudPlatform) {
    CloudPlatform["Unknown"] = "";
    CloudPlatform["TencentCloud"] = "tencentcloud";
    CloudPlatform["Other"] = "other";
})(CloudPlatform || (CloudPlatform = {}));
let hasDetected = false;
let cloudPlatform = CloudPlatform.Unknown;
function hasPreflight() {
    return hasDetected;
}
async function preflightRuntimeCloudPlatform() {
    if (hasDetected) {
        return;
    }
    if (await checkIsInternalAsync()) {
        cloudPlatform = CloudPlatform.TencentCloud;
    }
    else {
        cloudPlatform = CloudPlatform.Other;
    }
    hasDetected = true;
}
function getCloudPlatform() {
    return cloudPlatform;
}
function checkIsInScf() {
    return process.env.TENCENTCLOUD_RUNENV === 'SCF';
}
function checkIsInCBR() {
    // CBR = CLOUDBASE_RUN
    return !!process.env.CBR_ENV_ID;
}
const kSumeruEnvSet = new Set(['formal', 'pre', 'test']);
function checkIsInSumeru() {
    // SUMERU_ENV=formal | test | pre
    return kSumeruEnvSet.has(process.env.SUMERU_ENV);
}
async function checkIsInTencentCloud() {
    return (0, utils_1.isNonEmptyString)(await (0, metadata_1.lookupAppId)());
}
function checkIsInternal() {
    return checkIsInScf() || checkIsInCBR() || checkIsInSumeru();
}
async function checkIsInternalAsync() {
    return checkIsInternal() ? await Promise.resolve(true) : await checkIsInTencentCloud();
}
async function getCurrRunEnvTag() {
    if (checkIsInScf()) {
        return 'scf';
    }
    else if (checkIsInCBR()) {
        return 'cbr';
    }
    else if (checkIsInSumeru()) {
        return 'sumeru';
    }
    else if (await checkIsInTencentCloud()) {
        return 'tencentcloud';
    }
    return 'unknown';
}
